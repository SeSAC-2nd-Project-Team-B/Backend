<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì±„íŒ… ì‹œì‘í•˜ê¸°</title>
    <link rel="stylesheet" href="index.css">
</head>
<body>
    <div id="chat-container">
        
        <input id="token-input" type="text" placeholder="í† í°ì„ ì…ë ¥í•˜ì„¸ìš”.">
        <button id="fetch-user-button">ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°</button>
        <p id="user-info"></p>

        <input id="product-id-input" type="number" placeholder="ìƒí’ˆ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.">
        <button id="fetch-product-button" style="display: none;">ìƒí’ˆ ì •ë³´ ê°€ì ¸ì˜¤ê¸°</button>
        <p id="product-info"></p>

        <button id="show-rooms-button" style="display: none;">ì±„íŒ…ë°© ëª©ë¡ ë³´ê¸°</button>
        <button id="start-chat-button" style="display: none;">ìƒˆ ì±„íŒ… ì‹œì‘í•˜ê¸°</button>
        <div id="room-list" style="display: none;">
            <h3>ì±„íŒ…ë°© ëª©ë¡</h3>
            <ul id="room-list-items"></ul>
        </div>

        <div id="chat-box" style="display: none;">
            <div id="messages"></div>
            <div style="display: flex;">
                <input id="message-input" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”." style="flex: 1;">
                <button id="send-button">ì „ì†¡</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        let socket;
        let roomId;
        let userId;
        let userNickname;
        let buyerId;
        let sellerId;
        let senderId;
        let receiverId;
        let product;
        let productId;
        let token;

        // ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸° ë²„íŠ¼ í´ë¦­
        document.getElementById('fetch-user-button').onclick = async () => {
            token = document.getElementById('token-input').value;

            if (!token) {
                alert("í† í°ì„ ì…ë ¥í•˜ì„¸ìš”.");
                return;
            }

            try {
                const response = await fetch('/user/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ token })
                });

                if (response.ok) {
                    const user = await response.json();
                    userId = user.userId;
                    userNickname = user.nickname;
                    document.getElementById('user-info').textContent = `ì‚¬ìš©ì ID: ${userId}, ë‹‰ë„¤ì„: ${userNickname}`;
                    document.getElementById('fetch-product-button').style.display = 'inline-block';
                    document.getElementById('start-chat-button').style.display = 'inline-block';
                    document.getElementById('show-rooms-button').style.display = 'inline-block';
                } else {
                    alert("ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                }
            } catch (error) {
                console.error('ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
            }
        };

        // ìƒí’ˆ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ë²„íŠ¼ í´ë¦­
        document.getElementById('fetch-product-button').onclick = async () => {
            productId = document.getElementById('product-id-input').value;

            if (!productId) {
                alert("ìƒí’ˆ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
                return;
            }

            try {
                const response = await fetch(`/product/read?productId=${productId}`, {
                    method: 'GET'
                });

                if (response.ok) {
                product = await response.json();

                    if (product && product.userId) {
                        sellerId = product.userId; // ìƒí’ˆ ë“±ë¡ì = íŒë§¤ì
                        document.getElementById('product-info').textContent = `ìƒí’ˆ: ${product.productName} (ID: ${product.productId}), íŒë§¤ì ID: ${sellerId}`;
                    } else {
                        alert("ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    }
                    
                } else {
                    alert("ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                }

            } catch (error) {
                console.error('ìƒí’ˆ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                alert("ìƒí’ˆ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        };



        // ì±„íŒ…ë°© ëª©ë¡ ë³´ì—¬ì£¼ê¸° ë²„íŠ¼ í´ë¦­
        document.getElementById('show-rooms-button').onclick = async () => {
            try {
                const response = await fetch('/room/list', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ token })
                });

                if (response.ok) {
                    const rooms = await response.json();
                    console.log("ğŸš€ ~ document.getElementById ~ rooms:", rooms);
                    
                    const roomList = document.getElementById('room-list-items');
                    roomList.innerHTML = '';

                    if (Array.isArray(rooms)) {
                        rooms.forEach(room => {
                            const listItem = document.createElement('li');
                            listItem.textContent = `ì±„íŒ…ë°© ID: ${room.roomId}, ìƒí’ˆ ID: ${room.productId}`;

                            const joinButton = document.createElement('button');
                            joinButton.textContent = 'ì ‘ì†';
                            joinButton.onclick = () => {
                                roomId = room.roomId;
                                console.log("ì±„íŒ…ë°© ID:", roomId);

                                buyerId = room.buyerId;
                                sellerId = room.sellerId;

                                // senderIdëŠ” í˜„ì¬ ì‚¬ìš©ì(userId)ë¡œ ì„¤ì •
                                senderId = userId;

                                // receiverIdëŠ” senderIdê°€ buyerIdì¸ì§€ sellerIdì¸ì§€ì— ë”°ë¼ ì„¤ì •
                                receiverId = (senderId === buyerId) ? sellerId : buyerId;

                                productId = room.productId;

                                startChat(roomId);
                            };

                            listItem.appendChild(joinButton);
                            roomList.appendChild(listItem);
                        });
                    } else {
                        console.error('ë°°ì—´í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.', rooms);
                    }

                    document.getElementById('room-list').style.display = 'block';

                    // ìƒˆ ì±„íŒ… ì‹œì‘í•˜ê¸° ë²„íŠ¼ í‘œì‹œ
                    document.getElementById('start-chat-button').style.display = 'inline-block';
                } else {
                    alert("ì±„íŒ…ë°©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                }
            } catch (error) {
                console.error('ì±„íŒ…ë°© ëª©ë¡ ê°€ì ¸ì˜¤ê¸° ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
            }
        };

        // ìƒˆ ì±„íŒ… ì‹œì‘í•˜ê¸° ë²„íŠ¼ í´ë¦­
        document.getElementById('start-chat-button').onclick = async () => {
            buyerId = userId; // í˜„ì¬ ì‚¬ìš©ìê°€ êµ¬ë§¤ì
            senderId = buyerId; // ì±„íŒ… ì‹œì‘ ì‹œ êµ¬ë§¤ìê°€ ì²˜ìŒ ë©”ì‹œì§€ë¥¼ ë³´ëƒ„

            try {
                const response = await fetch('/room', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ productId, buyerId, sellerId })
                });
                console.log("ğŸš€ ~ document.getElementById ~  productId, buyerId, sellerId:",  productId, buyerId, sellerId);
                
                if (response.ok) {
                    const data = await response.json();
                    roomId = data.roomId;

                    console.log('ë£¸ì•„ì´ë””:', roomId);
                    console.log('êµ¬ë§¤ì ì•„ì´ë””:', buyerId);
                    console.log('íŒë§¤ì ì•„ì´ë””:', sellerId);
                    console.log('ìƒí’ˆì•„ì´ë””:', productId);

                    // receiverId ì„¤ì •
                    receiverId = sellerId;

                    startChat(roomId);
                } else {
                    alert("í•´ë‹¹ ìƒí’ˆì€ ë³¸ì¸ì´ íŒë§¤ìì¸ ìƒí’ˆì…ë‹ˆë‹¤.");
                }
            } catch (error) {
                console.error('ì±„íŒ…ë°© ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
            }
        };


        

        // ì±„íŒ… ì‹œì‘ í•¨ìˆ˜
        const startChat = async (roomId) => {
            socket = io();

            try {
                // ì§€ë‚œ ë©”ì‹œì§€ ê¸°ë¡ ê°€ì ¸ì˜¤ê¸°
                const response = await fetch(`/messages/${roomId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const messages = await response.json();
                    const messagesContainer = document.getElementById('messages');
                    messagesContainer.innerHTML = '';

                    messages.forEach((message) => {
                        const messageElement = document.createElement('div');

                        // senderIdê°€ í˜„ì¬ ìœ ì €ì˜ userIdì™€ ê°™ì€ì§€ í™•ì¸í•˜ì—¬ ë³´ë‚¸ ë©”ì‹œì§€ì¸ì§€, ë°›ì€ ë©”ì‹œì§€ì¸ì§€ êµ¬ë¶„
                        if (message.senderId === userId) {
                            messageElement.classList.add('message', 'sent'); // ë³´ë‚¸ ë©”ì‹œì§€
                        } else {
                            messageElement.classList.add('message', 'received'); // ë°›ì€ ë©”ì‹œì§€
                        }

                        // ë‹‰ë„¤ì„ê³¼ ë©”ì‹œì§€ ë‚´ìš©ì„ í•¨ê»˜ í‘œì‹œ
                        messageElement.textContent = `${message.Sender.nickname}: ${message.messageText}`;
                        messagesContainer.appendChild(messageElement);
                    });

                    messagesContainer.scrollTop = messagesContainer.scrollHeight; // ë©”ì‹œì§€ê°€ ìŒ“ì´ë©´ ìë™ ìŠ¤í¬ë¡¤
                } else {
                    console.error('ì§€ë‚œ ë©”ì‹œì§€ ê¸°ë¡ì´ ì—†ê±°ë‚˜ ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ì§€ë‚œ ë©”ì‹œì§€ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
            }

            // ì‹¤ì‹œê°„ ë©”ì‹œì§€ ìˆ˜ì‹  í•¸ë“¤ëŸ¬
            socket.on('receiveMessage', (message) => {
                const messages = document.getElementById('messages');
                const messageElement = document.createElement('div');

                if (message.senderId === userId) {
                    messageElement.classList.add('message', 'sent');
                } else {
                    messageElement.classList.add('message', 'received');
                }

                messageElement.textContent = `${message.senderNickname}: ${message.messageText}`;
                messages.appendChild(messageElement);
                messages.scrollTop = messages.scrollHeight;
            });

            socket.emit('joinRoom', { roomId, senderId, productId });
            console.log("ğŸš€ ~ startChat ~ roomId, senderId, productId:", roomId, senderId, productId)
            console.log('ë“¤ì–´ê°„ ì±„íŒ…ë°© ì•„ì´ë””:', roomId);

            document.getElementById('chat-box').style.display = 'block';
        };



        // ë©”ì„¸ì§€ ë³´ë‚´ê¸° í•¨ìˆ˜
        const sendMessage = () => {
            const messageText = document.getElementById('message-input').value;
            if (messageText.trim() !== '') {
                socket.emit('sendMessage', {
                    roomId,
                    senderId,
                    messageText
                });

                document.getElementById('message-input').value = '';
            }
        };


        document.getElementById('send-button').addEventListener('click', sendMessage);

        // ì…ë ¥ì´ ì™„ì „íˆ ëë‚¬ì„ ë•Œë§Œ ë©”ì‹œì§€ë¥¼ ì „ì†¡ // IME ì²˜ë¦¬ì—ì„œ í•œê¸€ ë§ˆì§€ë§‰ ê¸€ìê°€ ì¶”ê°€ë¡œ ë©”ì„¸ì§€ ë³´ë‚´ì§€ëŠ” ê²½ìš° í•´ê²° ë°©ë²•
        let isComposing = false;

        document.getElementById('message-input').addEventListener('compositionstart', () => {
            isComposing = true;
        });

        document.getElementById('message-input').addEventListener('compositionend', () => {
            isComposing = false;
        });

        document.getElementById('message-input').addEventListener('keydown', (event) => {
            if (event.key === 'Enter' && !isComposing) {
                event.preventDefault();
                sendMessage();
            }
        });


    </script>
</body>
</html>